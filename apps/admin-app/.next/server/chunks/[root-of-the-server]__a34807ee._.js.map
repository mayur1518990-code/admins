{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///D:/majalgav/hosting%20admin/apps/admin-app/src/lib/firebase-admin.ts"],"sourcesContent":["import { initializeApp, getApps, cert } from 'firebase-admin/app';\r\nimport { getAuth } from 'firebase-admin/auth';\r\nimport { getFirestore } from 'firebase-admin/firestore';\r\nimport { getStorage } from 'firebase-admin/storage';\r\n\r\n// Initialize Firebase Admin\r\nconst privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/^\"|\"$/g, '') || '';\r\n\r\nconst firebaseAdminConfig = {\r\n  credential: cert({\r\n    projectId: process.env.FIREBASE_PROJECT_ID,\r\n    clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n    privateKey: privateKey,\r\n  }),\r\n};\r\n\r\n// Initialize Firebase Admin\r\nconst adminApp = getApps().length === 0 ? initializeApp(firebaseAdminConfig) : getApps()[0];\r\n\r\n// Initialize Firebase Admin services\r\nexport const adminAuth = getAuth(adminApp);\r\nexport const adminDb = getFirestore(adminApp);\r\nexport const adminStorage = getStorage(adminApp);\r\n\r\nexport default adminApp;\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;;;;;;;;AAEA,4BAA4B;AAC5B,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB,EAAE,QAAQ,UAAU,OAAO;AAE9E,MAAM,sBAAsB;IAC1B,YAAY,IAAA,wJAAI,EAAC;QACf,WAAW,QAAQ,GAAG,CAAC,mBAAmB;QAC1C,aAAa,QAAQ,GAAG,CAAC,qBAAqB;QAC9C,YAAY;IACd;AACF;AAEA,4BAA4B;AAC5B,MAAM,WAAW,IAAA,2JAAO,IAAG,MAAM,KAAK,IAAI,IAAA,iKAAa,EAAC,uBAAuB,IAAA,2JAAO,GAAE,CAAC,EAAE;AAGpF,MAAM,YAAY,IAAA,6JAAO,EAAC;AAC1B,MAAM,UAAU,IAAA,4KAAY,EAAC;AAC7B,MAAM,eAAe,IAAA,sKAAU,EAAC;uCAExB","debugId":null}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///D:/majalgav/hosting%20admin/apps/admin-app/src/lib/get-default-agent.ts"],"sourcesContent":["import { adminDb } from './firebase-admin';\r\n\r\n/**\r\n * Get the first active agent from the database\r\n * This is used for development when we need to map to a real agent\r\n */\r\nexport async function getDefaultAgent() {\r\n  try {\r\n    const agentsSnapshot = await adminDb.collection('agents')\r\n      .where('isActive', '==', true)\r\n      .limit(1)\r\n      .get();\r\n\r\n    if (!agentsSnapshot.empty) {\r\n      const agentDoc = agentsSnapshot.docs[0];\r\n      const agentData = agentDoc.data();\r\n      \r\n      return {\r\n        agentId: agentDoc.id,\r\n        name: agentData.name || 'Unknown Agent',\r\n        email: agentData.email || 'unknown@example.com',\r\n        role: 'agent'\r\n      };\r\n    }\r\n\r\n    // Fallback to hardcoded values if no agents found\r\n    return {\r\n      agentId: \"bim290LXmEf6N7IuTzKU7bv5XcG2\",\r\n      name: \"Sunny Atul Dhore\", \r\n      email: \"dhoresunny5648@gmail.com\",\r\n      role: \"agent\"\r\n    };\r\n  } catch (error) {\r\n    console.error('Error getting default agent:', error);\r\n    // Fallback to hardcoded values\r\n    return {\r\n      agentId: \"bim290LXmEf6N7IuTzKU7bv5XcG2\",\r\n      name: \"Sunny Atul Dhore\",\r\n      email: \"dhoresunny5648@gmail.com\", \r\n      role: \"agent\"\r\n    };\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAMO,eAAe;IACpB,IAAI;QACF,MAAM,iBAAiB,MAAM,oKAAO,CAAC,UAAU,CAAC,UAC7C,KAAK,CAAC,YAAY,MAAM,MACxB,KAAK,CAAC,GACN,GAAG;QAEN,IAAI,CAAC,eAAe,KAAK,EAAE;YACzB,MAAM,WAAW,eAAe,IAAI,CAAC,EAAE;YACvC,MAAM,YAAY,SAAS,IAAI;YAE/B,OAAO;gBACL,SAAS,SAAS,EAAE;gBACpB,MAAM,UAAU,IAAI,IAAI;gBACxB,OAAO,UAAU,KAAK,IAAI;gBAC1B,MAAM;YACR;QACF;QAEA,kDAAkD;QAClD,OAAO;YACL,SAAS;YACT,MAAM;YACN,OAAO;YACP,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,+BAA+B;QAC/B,OAAO;YACL,SAAS;YACT,MAAM;YACN,OAAO;YACP,MAAM;QACR;IACF;AACF","debugId":null}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///D:/majalgav/hosting%20admin/apps/admin-app/src/lib/agent-auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\nimport { cookies } from \"next/headers\";\nimport { adminAuth, adminDb } from \"./firebase-admin\";\nimport { getDefaultAgent } from \"./get-default-agent\";\n\n// Agent authentication helper that verifies against agents collection\n// OPTIMIZED: Removed expensive fallback to getDefaultAgent on every error\nexport async function verifyAgentAuth() {\n  const startTime = Date.now();\n  \n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get('agent-token')?.value;\n    \n    // For development, we'll allow access with a simple token check\n    if (token === 'dev_agent_token') {\n      // Get the first active agent from the database\n      const defaultAgent = await getDefaultAgent();\n      console.log(`[PERF] verifyAgentAuth (dev mode): ${Date.now() - startTime}ms`);\n      return defaultAgent;\n    }\n\n    if (!token) {\n      throw new Error('No agent authentication token found');\n    }\n\n    // FIXED: Use verifySessionCookie or decode the token without verification\n    // Since we create custom tokens on the server, we can decode them without verification\n    try {\n      const verifyStart = Date.now();\n      \n      // Try to verify as ID token first (for Firebase Auth tokens)\n      const decodedToken = await adminAuth.verifyIdToken(token).catch(async (err) => {\n        // If it fails because it's a custom token, decode it without verification\n        // Custom tokens are JWTs we created ourselves, so we can trust them\n        if (err.code === 'auth/argument-error') {\n          console.log(`[AUTH] Token is a custom token, decoding without verification`);\n          // Decode JWT without verification (we created it, so it's safe)\n          const parts = token.split('.');\n          if (parts.length === 3) {\n            const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString());\n            console.log(`[PERF] Token decode: ${Date.now() - verifyStart}ms`);\n            return payload.claims || payload;\n          }\n        }\n        throw err;\n      });\n      \n      console.log(`[PERF] Token verification: ${Date.now() - verifyStart}ms`);\n      \n      // Check if this is a custom token with agent role\n      if (decodedToken.role === 'agent') {\n        console.log(`[PERF] verifyAgentAuth (custom token): ${Date.now() - startTime}ms`);\n        return {\n          agentId: decodedToken.agentId || decodedToken.uid,\n          name: decodedToken.name || 'Agent',\n          email: decodedToken.email || 'agent@example.com',\n          role: \"agent\"\n        };\n      }\n      \n      // Get agent data from agents collection\n      const queryStart = Date.now();\n      const agentDoc = await adminDb.collection('agents').doc(decodedToken.uid).get();\n      console.log(`[PERF] Agent doc query: ${Date.now() - queryStart}ms`);\n      \n      if (!agentDoc.exists) {\n        throw new Error('Agent not found in database');\n      }\n\n      const agentData = agentDoc.data();\n      \n      if (!agentData?.isActive) {\n        throw new Error('Agent account is deactivated');\n      }\n\n      console.log(`[PERF] verifyAgentAuth total: ${Date.now() - startTime}ms`);\n      return {\n        agentId: decodedToken.uid,\n        name: agentData.name,\n        email: agentData.email,\n        role: \"agent\"\n      };\n    } catch (tokenError) {\n      console.error('[AUTH] Token verification failed:', tokenError);\n      throw tokenError;\n    }\n  } catch (error) {\n    // OPTIMIZATION: Only use fallback in dev environment, not production\n    if (process.env.NODE_ENV === 'development') {\n      console.log(`[DEV] Auth error, using default agent:`, error);\n      const defaultAgent = await getDefaultAgent();\n      console.log(`[PERF] verifyAgentAuth (fallback): ${Date.now() - startTime}ms`);\n      return defaultAgent;\n    }\n    // In production, throw error instead of expensive fallback\n    throw error;\n  }\n}\n\n// Helper function to get query parameters\nexport function getQueryParams(request: NextRequest) {\n  const { searchParams } = new URL(request.url);\n  return {\n    filter: searchParams.get('filter') || 'all',\n    dateFilter: searchParams.get('dateFilter') || 'all',\n    search: searchParams.get('search') || '',\n    limit: parseInt(searchParams.get('limit') || '50'),\n    offset: parseInt(searchParams.get('offset') || '0'),\n    status: searchParams.get('status'),\n    userId: searchParams.get('userId'),\n    fileId: searchParams.get('fileId'),\n    startDate: searchParams.get('startDate'),\n    endDate: searchParams.get('endDate')\n  };\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 305, "column": 0}, "map": {"version":3,"sources":["file:///D:/majalgav/hosting%20admin/apps/admin-app/src/app/api/agent/files/%5BfileId%5D/download/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebase-admin';\nimport { verifyAgentAuth } from '@/lib/agent-auth';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ fileId: string }> }\n) {\n  const startTime = Date.now();\n  \n  try {\n    // Verify agent authentication\n    const agent = await verifyAgentAuth();\n    if (!agent) {\n      return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const { fileId } = await params;\n\n    // Get file information\n    const queryStart = Date.now();\n    const fileDoc = await adminDb.collection('files').doc(fileId).get();\n    console.log(`[PERF] File query: ${Date.now() - queryStart}ms`);\n    if (!fileDoc.exists) {\n      return NextResponse.json({\n        success: false,\n        error: 'File not found'\n      }, { status: 404 });\n    }\n\n    const fileData = fileDoc.data();\n    \n    // Verify the file is assigned to this agent\n    if (fileData?.assignedAgentId !== agent.agentId) {\n      return NextResponse.json({\n        success: false,\n        error: 'File not assigned to you'\n      }, { status: 403 });\n    }\n\n    // Get file content from database\n    const fileContent = fileData.fileContent;\n    \n    if (!fileContent) {\n      return NextResponse.json({\n        success: false,\n        error: 'File content not found in database'\n      }, { status: 404 });\n    }\n\n    try {\n      // Handle data URL format (data:mimeType;base64,content) or pure base64\n      let base64Content = fileContent;\n      if (fileContent.startsWith('data:')) {\n        // Extract base64 content from data URL\n        const base64Index = fileContent.indexOf(',');\n        if (base64Index !== -1) {\n          base64Content = fileContent.substring(base64Index + 1);\n        }\n      }\n      \n      // Convert base64 content back to buffer\n      const buffer = Buffer.from(base64Content, 'base64');\n      \n      // Set appropriate headers for file download\n      const headers = new Headers();\n      headers.set('Content-Type', fileData.mimeType || 'application/octet-stream');\n      headers.set('Content-Disposition', `attachment; filename=\"${fileData.originalName}\"`);\n      headers.set('Content-Length', buffer.length.toString());\n\n      console.log(`[PERF] Download total: ${Date.now() - startTime}ms, size: ${buffer.length} bytes`);\n\n      // Return the file content\n      return new NextResponse(buffer, {\n        status: 200,\n        headers\n      });\n\n    } catch (error) {\n      console.error('File processing error:', error);\n      return NextResponse.json({\n        success: false,\n        error: 'Failed to process file content'\n      }, { status: 500 });\n    }\n\n  } catch (error: any) {\n    console.error('Error downloading file:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to download file' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEO,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAA2C;IAEnD,MAAM,YAAY,KAAK,GAAG;IAE1B,IAAI;QACF,8BAA8B;QAC9B,MAAM,QAAQ,MAAM,IAAA,wKAAe;QACnC,IAAI,CAAC,OAAO;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpF;QAEA,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM;QAEzB,uBAAuB;QACvB,MAAM,aAAa,KAAK,GAAG;QAC3B,MAAM,UAAU,MAAM,oKAAO,CAAC,UAAU,CAAC,SAAS,GAAG,CAAC,QAAQ,GAAG;QACjE,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,KAAK,GAAG,KAAK,WAAW,EAAE,CAAC;QAC7D,IAAI,CAAC,QAAQ,MAAM,EAAE;YACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,MAAM,WAAW,QAAQ,IAAI;QAE7B,4CAA4C;QAC5C,IAAI,UAAU,oBAAoB,MAAM,OAAO,EAAE;YAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,iCAAiC;QACjC,MAAM,cAAc,SAAS,WAAW;QAExC,IAAI,CAAC,aAAa;YAChB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,IAAI;YACF,uEAAuE;YACvE,IAAI,gBAAgB;YACpB,IAAI,YAAY,UAAU,CAAC,UAAU;gBACnC,uCAAuC;gBACvC,MAAM,cAAc,YAAY,OAAO,CAAC;gBACxC,IAAI,gBAAgB,CAAC,GAAG;oBACtB,gBAAgB,YAAY,SAAS,CAAC,cAAc;gBACtD;YACF;YAEA,wCAAwC;YACxC,MAAM,SAAS,OAAO,IAAI,CAAC,eAAe;YAE1C,4CAA4C;YAC5C,MAAM,UAAU,IAAI;YACpB,QAAQ,GAAG,CAAC,gBAAgB,SAAS,QAAQ,IAAI;YACjD,QAAQ,GAAG,CAAC,uBAAuB,CAAC,sBAAsB,EAAE,SAAS,YAAY,CAAC,CAAC,CAAC;YACpF,QAAQ,GAAG,CAAC,kBAAkB,OAAO,MAAM,CAAC,QAAQ;YAEpD,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,KAAK,GAAG,KAAK,UAAU,UAAU,EAAE,OAAO,MAAM,CAAC,MAAM,CAAC;YAE9F,0BAA0B;YAC1B,OAAO,IAAI,gJAAY,CAAC,QAAQ;gBAC9B,QAAQ;gBACR;YACF;QAEF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAA0B,GACnD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}